function initializeFontLoading(){const loadingOverlay=document.getElementById('loading-spinner');const mainContent=document.getElementById('main-content');if('fonts'in document){const fontLoadingPromise=document.fonts.ready;const timeoutPromise=new Promise((resolve)=>{setTimeout(resolve,2000);});Promise.race([fontLoadingPromise,timeoutPromise]).then(()=>showContent()).catch(()=>showContent());}else{setTimeout(showContent,1000);}
function showContent(){loadingOverlay.classList.add('hidden');mainContent.classList.add('loaded');setTimeout(()=>{if(loadingOverlay&&loadingOverlay.parentNode){loadingOverlay.remove();}},500);}}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initializeFontLoading);}else{initializeFontLoading();}
const requestIdleCallback=window.requestIdleCallback||function(cb){return setTimeout(function(){const start=Date.now();cb({didTimeout:false,timeRemaining:function(){return Math.max(0,50-(Date.now()-start));}});},1);};function processDropcap(){const firstPWithoutTime=document.querySelector('main p:not(:has(time)):not(blockquote p)');if(!firstPWithoutTime)return;firstPWithoutTime.classList.add('drop-cap');const originalHTML=firstPWithoutTime.innerHTML;const tempDiv=document.createElement('div');tempDiv.innerHTML=originalHTML;const textContent=tempDiv.textContent||tempDiv.innerText;const words=textContent.trim().split(/\s+/);if(words.length>=3){const walker=document.createTreeWalker(tempDiv,NodeFilter.SHOW_TEXT,null,false);let targetWordCount=3;let textNodes=[];let node;while((node=walker.nextNode())){textNodes.push(node);}
let splitNode=null;let splitOffset=0;let currentWordCount=0;for(let textNode of textNodes){const nodeText=textNode.textContent;const nodeWords=nodeText.trim().split(/\s+/).filter((word)=>word.length>0);if(currentWordCount+nodeWords.length>=targetWordCount){splitNode=textNode;const wordsNeeded=targetWordCount-currentWordCount;let wordsSeen=0;let splitFound=false;for(let i=0;i<nodeText.length;i++){if(nodeText[i].match(/\s/)){if(wordsSeen>=wordsNeeded){splitOffset=i;splitFound=true;break;}}else if(i===0||nodeText[i-1].match(/\s/)){wordsSeen++;}}
if(wordsSeen>=wordsNeeded&&!splitFound){for(let i=splitOffset;i<nodeText.length;i++){if(nodeText[i].match(/\s/)){splitOffset=i;break;}
if(i===nodeText.length-1){splitOffset=i+1;break;}}}
break;}
currentWordCount+=nodeWords.length;}
if(splitNode&&splitOffset>0){const beforeText=splitNode.textContent.substring(0,splitOffset);const afterText=splitNode.textContent.substring(splitOffset);const firstLetterMatch=beforeText.match(/^\s*(\S)/);const parent=splitNode.parentNode;if(firstLetterMatch){const firstLetter=firstLetterMatch[1];const firstLetterIndex=beforeText.indexOf(firstLetter);const firstLetterDiv=document.createElement('div');firstLetterDiv.className='first-letter';firstLetterDiv.textContent=firstLetter;const remainingText=beforeText.slice(0,firstLetterIndex)+
beforeText.slice(firstLetterIndex+1);const threeWordsSpan=document.createElement('span');threeWordsSpan.className='first-three-words';threeWordsSpan.textContent=remainingText.trim();parent.insertBefore(firstLetterDiv,splitNode);parent.insertBefore(threeWordsSpan,splitNode);}else{const span=document.createElement('span');span.className='first-three-words';span.textContent=beforeText.trim();parent.insertBefore(span,splitNode);}
if(afterText.trim()){splitNode.textContent=afterText;}else{parent.removeChild(splitNode);}
firstPWithoutTime.innerHTML=tempDiv.innerHTML;}}}
window.addEventListener('load',()=>{requestIdleCallback(()=>{processDropcap();},{timeout:2000});});function addHeaderNumbering(){const headers=document.querySelectorAll('h2, h3, h4, h5, h6');const counters=[0,0,0,0,0];headers.forEach(header=>{const level=parseInt(header.tagName.charAt(1))-2;counters[level]++;for(let i=level+1;i<counters.length;i++){counters[i]=0;}
let numbering='';for(let i=0;i<=level;i++){if(counters[i]>0){numbering+=(numbering?'.':'')+counters[i];}}
if(numbering){header.textContent=numbering+'. '+header.textContent;}});}
addHeaderNumbering();function moveFootnotesToSidenotes(){const sidenoteContainer=document.querySelector('.sidenote-container');if(!sidenoteContainer)return;const footnoteDiv=document.querySelector('.footnote');if(!footnoteDiv)return;const footnoteRefs=document.querySelectorAll('sup[id^="fnref:"] a.footnote-ref');if(!footnoteRefs.length)return;const footnoteMap=new Map();const footnoteItems=footnoteDiv.querySelectorAll('li[id^="fn:"]');footnoteItems.forEach(item=>{const id=item.id;const content=item.innerHTML.replace(/<a class="footnote-backref".*?<\/a>/g,'');footnoteMap.set(id,content);});const isViewportWideEnough=()=>window.innerWidth>=768;const toggleFootnoteMode=()=>{const sidenoteElements=document.querySelectorAll('.sidenote-footnote');if(isViewportWideEnough()){sidenoteElements.forEach(el=>el.style.display='block');footnoteDiv.style.display='none';sidenoteContainer.style.display='block';}else{sidenoteElements.forEach(el=>el.style.display='none');footnoteDiv.style.display='block';sidenoteContainer.style.display='none';}};footnoteRefs.forEach((ref,index)=>{const href=ref.getAttribute('href');if(!href||!href.startsWith('#fn:'))return;const footnoteId=href.slice(1);const footnoteContent=footnoteMap.get(footnoteId);if(footnoteContent){const sidenoteFootnote=document.createElement('div');sidenoteFootnote.className='sidenote-footnote';sidenoteFootnote.id=`sidenote-${footnoteId}`;const tempDiv=document.createElement('div');tempDiv.innerHTML=footnoteContent;const paragraphs=tempDiv.querySelectorAll('p');paragraphs.forEach(p=>{const parent=p.parentNode;while(p.firstChild){parent.insertBefore(p.firstChild,p);}
parent.removeChild(p);});sidenoteFootnote.innerHTML=tempDiv.innerHTML;const marker=document.createElement('span');marker.className='sidenote-footnote-marker';marker.textContent=ref.textContent;sidenoteFootnote.prepend(marker);sidenoteContainer.appendChild(sidenoteFootnote);const supElement=ref.closest('sup[id^="fnref:"]');positionSidenoteFootnote(supElement||ref,sidenoteFootnote);window.addEventListener('resize',()=>{toggleFootnoteMode();if(isViewportWideEnough()){const supElement=ref.closest('sup[id^="fnref:"]');positionSidenoteFootnote(supElement||ref,sidenoteFootnote);}});ref.addEventListener('click',(e)=>{e.preventDefault();if(isViewportWideEnough()){highlightSidenoteFootnote(sidenoteFootnote);}else{window.location.href=href;}});}});toggleFootnoteMode();}
function positionSidenoteFootnote(reference,footnote){const refRect=reference.getBoundingClientRect();const mainContent=document.querySelector('.column-content');const sidenoteColumn=document.querySelector('.column-sidenotes');if(!mainContent||!sidenoteColumn)return;const mainRect=mainContent.getBoundingClientRect();const sidenoteRect=sidenoteColumn.getBoundingClientRect();const footnoteHeight=footnote.getBoundingClientRect().height;const referenceHeight=refRect.height;const verticalOffset=(referenceHeight-footnoteHeight)/2;const relativeTop=refRect.top-sidenoteRect.top+verticalOffset;footnote.style.top=`${relativeTop}px`;footnote.classList.add('positioned');}
function highlightSidenoteFootnote(footnote){document.querySelectorAll('.sidenote-footnote').forEach(note=>{note.style.backgroundColor='';});footnote.style.backgroundColor='rgba(150, 150, 150, 0.1)';footnote.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>{footnote.style.backgroundColor='';},2000);}
document.addEventListener('DOMContentLoaded',()=>{requestIdleCallback(()=>{moveFootnotesToSidenotes();},{timeout:1000});window.addEventListener('load',()=>{requestIdleCallback(()=>{document.querySelectorAll('.sidenote-footnote').forEach(footnote=>{const footnoteId=footnote.id;if(footnoteId&&footnoteId.startsWith('sidenote-fn:')){const refId='fnref:'+footnoteId.replace('sidenote-fn:','');const reference=document.getElementById(refId);if(reference){positionSidenoteFootnote(reference,footnote);}}});},{timeout:2000});});});document.querySelectorAll('sup[id^="fnref:"] a.footnote-ref').forEach((ref)=>{const tooltip=document.getElementById('footnote-tooltip');if(!tooltip)return;ref.addEventListener('mouseenter',()=>{const sidenoteColumn=document.querySelector('.column-sidenotes');if(sidenoteColumn&&window.getComputedStyle(sidenoteColumn).display!=='none'){return;}
const href=ref.getAttribute('href');if(!href||!href.startsWith('#fn:'))return;const footnoteId=href.slice(1);const footnote=document.getElementById(footnoteId);if(footnote){const clone=footnote.cloneNode(true);const backRef=clone.querySelector('.footnote-backref');if(backRef)backRef.remove();tooltip.innerHTML=clone.innerHTML;tooltip.style.visibility='hidden';tooltip.style.display='block';tooltip.style.left='-9999px';tooltip.style.top='-9999px';requestAnimationFrame(()=>{const tooltipWidth=tooltip.offsetWidth;const tooltipHeight=tooltip.offsetHeight;const padding=12;const viewportWidth=window.innerWidth;const viewportHeight=window.innerHeight;const updatePosition=(e)=>{let left=e.clientX+10;let top=e.clientY+10;if(left+tooltipWidth+padding>viewportWidth){left=viewportWidth-tooltipWidth-padding;}
if(top+tooltipHeight+padding>viewportHeight){top=viewportHeight-tooltipHeight-padding;}
left=Math.max(padding,left);top=Math.max(padding,top);tooltip.style.left=`${left}px`;tooltip.style.top=`${top}px`;};tooltip.style.visibility='visible';const onMouseMove=(e)=>updatePosition(e);ref.addEventListener('mousemove',onMouseMove);const onLeave=()=>{tooltip.style.display='none';tooltip.style.visibility='hidden';ref.removeEventListener('mousemove',onMouseMove);ref.removeEventListener('mouseleave',onLeave);};ref.addEventListener('mouseleave',onLeave);});}});});